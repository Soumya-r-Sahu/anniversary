/**
 * Anniversary Website Data Management System - Enhanced v4.0.0
 * Dark Theme Support, Content-Focused Architecture, Performance Optimized
 * Unified Data Layer with Intelligent Caching and Real-time Updates
 */

class DataManager {
    constructor() {
        this.storageKey = 'anniversary_v4_data';
        this.backupKey = 'anniversary_v4_backup';
        this.themeKey = 'anniversary_v4_theme';
        this.version = '4.0.0';
        
        // Performance optimization
        this.cache = new Map();
        this.cacheTTL = 300000; // 5 minutes
        this.subscribers = new Map();
        
        // Initialize theme (default to dark)
        this.initializeTheme();
        
        // Initialize data structure
        this.defaultData = this.createOptimizedDataStructure();
        this.data = this.loadData();
        
        // Performance monitoring
        this.performanceMetrics = {
            loadTime: 0,
            cacheHits: 0,
            cacheMisses: 0
        };
        
        // Auto-optimize on init
        this.optimizePerformance();
        
        console.log('üöÄ Enhanced Data Manager v4.0.0 initialized');
    }

    /**
     * Initialize theme system with dark as default
     */
    initializeTheme() {
        const savedTheme = localStorage.getItem(this.themeKey);
        const theme = savedTheme || 'dark'; // Default to dark theme
        
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem(this.themeKey, theme);
        
        // Apply theme classes to body for better styling
        document.body.className = `theme-${theme} anniversary-app`;
    }

    /**
     * Create optimized data structure with content-focused naming
     */
    createOptimizedDataStructure() {
        return {
            version: this.version,
            lastUpdated: new Date().toISOString(),
            theme: 'dark',
            
            // Core relationship data
            relationship: {
                partners: {
                    soumya: {
                        name: "Soumya", 
                        nickname: "Mankada",
                        role: "beloved",
                        theme_color: "#ec4899"
                    },
                    puja: {
                        name: "Puja",
                        nickname: "Jerry", 
                        role: "sweetheart",
                        theme_color: "#8b5cf6"
                    }
                },
                timeline: {
                    start_date: "2024-06-16",
                    anniversary_date: "2025-06-16", 
                    milestone_months: [1, 3, 6, 12],
                    current_phase: "deepening_love"
                }
            },

            // Content-focused memory system
            memories: {
                moments: [
                    {
                        id: "first_hello",
                        date: "2024-06-16",
                        title: "First Sweet Message üíå",
                        content: "The very first message that started our beautiful journey together.",
                        emotion: "joy",
                        significance: 10,
                        tags: ["beginning", "first_contact", "milestone"],
                        is_favorite: true
                    },
                    {
                        id: "first_love_confession", 
                        date: "2024-06-19",
                        title: "First 'I Love You' üíï",
                        content: "During our amazing 3-hour phone call, when you said 'Love you' for the first time.",
                        emotion: "euphoria",
                        significance: 10,
                        tags: ["love", "confession", "phone_call"],
                        is_favorite: true
                    }
                ],
                categories: ["milestones", "daily_joys", "deep_connections", "future_dreams"],
                emotional_palette: ["joy", "love", "excitement", "contentment", "euphoria"]
            },

            // Visual content system
            media: {
                photos: [
                    {
                        id: "memory_snapshot_001",
                        title: "Our First Meeting",
                        description: "The day our hearts first connected",
                        emotion: "magical",
                        date: "2024-06-16",
                        is_favorite: true
                    }
                ],
                galleries: {
                    "special_moments": { name: "Special Moments", count: 0 },
                    "daily_life": { name: "Daily Life Together", count: 0 },
                    "future_plans": { name: "Dreams & Plans", count: 0 }
                }
            },

            // Communication archive
            messages: {
                love_letters: [
                    {
                        id: "five_month_letter",
                        date: "2024-11-16", 
                        title: "5 Month Anniversary Letter",
                        content: "My beautiful Puja, as we celebrate 5 wonderful months together...",
                        from: "soumya",
                        to: "puja",
                        emotion: "romantic"
                    }
                ],
                daily_affirmations: [
                    "You are my sunshine",
                    "Every day with you is a gift", 
                    "You make my heart complete"
                ],
                sweet_names: ["Jerry", "Mankada", "My Love", "Sweetheart", "Beautiful"]
            },

            // Experience planning
            plans: {
                future_dreams: [
                    {
                        id: "weekend_getaway",
                        title: "Romantic Weekend Together",
                        description: "A perfect weekend just for us",
                        priority: "high",
                        emotion: "excitement",
                        status: "dreaming"
                    }
                ],
                bucket_list: [],
                special_dates: [
                    {
                        id: "monthly_celebration",
                        name: "Monthly Anniversary",
                        date: "16th of every month",
                        type: "recurring",
                        celebration_ideas: ["special dinner", "love letter", "memory sharing"]
                    }
                ]
            },

            // App preferences
            settings: {
                theme: "dark",
                animations: true,
                auto_music: true,
                notifications: true,
                privacy_mode: false,
                content_focus: "romantic_emphasis"
            },

            // Analytics for optimization
            usage: {
                total_memories: 2,
                total_photos: 1, 
                total_letters: 1,
                days_together: this.calculateDaysTogether("2024-06-16"),
                last_visit: new Date().toISOString(),
                favorite_features: ["memories", "countdown", "love_letters"]
            }
        };
    }

            // Timeline/Memories Data
            timeline: [
                {
                    id: 1,
                    date: "2024-06-16",
                    title: "First Sweet Message üíå",
                    description: "The very first message that started our beautiful journey together. A simple hello that changed everything!",
                    category: "milestone",
                    image: null,
                    location: null,
                    tags: ["first", "message", "beginning"],
                    favorite: true
                },
                {
                    id: 2,
                    date: "2024-06-19",
                    title: "First 'I Love You' üíï",
                    description: "During our amazing 3-hour phone call, when you said 'Love you' for the first time. I was so happy I couldn't even explain it! My heart was dancing. üêíüíï",
                    category: "milestone",
                    image: null,
                    location: null,
                    tags: ["love", "phone call", "confession"],
                    favorite: true
                },
                {
                    id: 3,
                    date: "2024-07-01",
                    title: "Growing Closer Every Day üå±",
                    description: "Daily conversations, sharing dreams, and discovering how perfectly we complement each other. You became my sweet Jerry, and I became your loving Mankada.",
                    category: "growth",
                    image: null,
                    location: null,
                    tags: ["growth", "conversations", "nicknames"],
                    favorite: false
                },
                {
                    id: 4,
                    date: "2024-08-15",
                    title: "Deep Heart Connection üíñ",
                    description: "Understanding each other's hearts, sharing our deepest thoughts, and realizing we're truly soulmates. Every conversation brought us closer.",
                    category: "connection",
                    image: null,
                    location: null,
                    tags: ["connection", "soulmates", "deep"],
                    favorite: true
                },
                {
                    id: 5,
                    date: "2024-10-01",
                    title: "Best Friends Forever üë´",
                    description: "Not just lovers, but the best of friends. Sharing jokes, supporting each other through everything, and finding joy in the simplest moments together.",
                    category: "friendship",
                    image: null,
                    location: null,
                    tags: ["friendship", "support", "joy"],
                    favorite: false
                },
                {
                    id: 6,
                    date: "2024-11-16",
                    title: "5 Months of Pure Love üéâ",
                    description: "Celebrating 5 incredible months of love, laughter, and beautiful memories. Each day with you has been a gift, my sweet Jerry! üêíüíï",
                    category: "anniversary",
                    image: null,
                    location: null,
                    tags: ["5 months", "celebration", "love"],
                    favorite: true
                }
            ],

            // Photo Gallery Data
            photos: [
                {
                    id: 1,
                    filename: "first-meeting.jpg",
                    title: "Our First Meeting",
                    description: "The day our hearts first connected",
                    date: "2024-06-16",
                    category: "milestones",
                    tags: ["first", "meeting", "beginning"],
                    favorite: true,
                    uploaded: new Date().toISOString()
                },
                {
                    id: 2,
                    filename: "memory1.jpg",
                    title: "Beautiful Memory",
                    description: "A precious moment captured in time",
                    date: "2024-07-01",
                    category: "memories",
                    tags: ["memory", "beautiful", "precious"],
                    favorite: false,
                    uploaded: new Date().toISOString()
                }
            ],

            // Love Letters/Messages
            loveLetters: [
                {
                    id: 1,
                    date: "2024-11-16",
                    title: "5 Month Anniversary Letter",
                    content: "My beautiful Puja, as we celebrate 5 wonderful months together, I want you to know how much you mean to me. You are my sunshine, my joy, and my everything. Thank you for being my sweet Jerry. I love you more each day! üíï",
                    author: "Soumya",
                    recipient: "Puja",
                    mood: "romantic",
                    tags: ["anniversary", "5 months", "love"],
                    favorite: true
                }
            ],

            // Music Playlist Data
            musicPlaylist: [
                {
                    id: 1,
                    title: "Our Song",
                    artist: "Unknown",
                    filename: "romantic-song.mp3",
                    duration: null,
                    addedDate: "2024-06-16",
                    description: "The song that reminds us of our love",
                    tags: ["romantic", "our song"],
                    favorite: true
                }
            ],

            // Special Dates & Events
            specialDates: [
                {
                    id: 1,
                    name: "Monthly Anniversary",
                    date: "16th of every month",
                    type: "recurring",
                    description: "Celebrating another month of love",
                    notificationEnabled: true,
                    category: "anniversary"
                },
                {
                    id: 2,
                    name: "1 Year Anniversary",
                    date: "2025-06-16",
                    type: "special",
                    description: "Our first year celebration!",
                    notificationEnabled: true,
                    category: "milestone"
                }
            ],

            // Wish List & Future Plans
            wishList: [
                {
                    id: 1,
                    title: "Weekend Getaway",
                    description: "A romantic weekend trip together",
                    priority: "high",
                    category: "travel",
                    estimated_cost: null,
                    target_date: null,
                    completed: false,
                    tags: ["travel", "romance", "weekend"]
                }
            ],

            // Settings & Preferences
            settings: {
                theme: "romantic",
                musicAutoplay: true,
                animations: true,
                notifications: true,
                privacy: {
                    sharePhotos: false,
                    publicProfile: false
                },
                display: {
                    showTimeline: true,
                    showPhotos: true,
                    showMusic: true,
                    heartAnimations: true
                }
            },

            // Analytics & Statistics
            statistics: {
                totalMemories: 6,
                totalPhotos: 2,
                totalLetters: 1,
                totalSongs: 1,
                daysogether: this.calculateDaysTogether("2024-06-16"),
                siteLaunched: new Date().toISOString(),
                lastVisit: new Date().toISOString()
            }
        };
    }

    /**
     * Load data from localStorage or return default data
     */
    loadData() {
        try {
            const stored = localStorage.getItem(this.storageKey);
            if (stored) {
                const parsedData = JSON.parse(stored);
                // Merge with defaults to ensure all fields exist
                return this.mergeWithDefaults(parsedData);
            }
        } catch (error) {
            console.warn('Error loading stored data:', error);
        }
        
        // Return default data if nothing stored or error occurred
        return this.defaultData;
    }

    /**
     * Merge stored data with defaults to ensure completeness
     */
    mergeWithDefaults(storedData) {
        const merged = { ...this.defaultData };
        
        // Deep merge stored data
        Object.keys(storedData).forEach(key => {
            if (typeof storedData[key] === 'object' && !Array.isArray(storedData[key])) {
                merged[key] = { ...merged[key], ...storedData[key] };
            } else {
                merged[key] = storedData[key];
            }
        });

        return merged;
    }

    /**
     * Save data to localStorage
     */
    saveData() {
        try {
            this.data.lastUpdated = new Date().toISOString();
            this.data.statistics.lastVisit = new Date().toISOString();
            
            localStorage.setItem(this.storageKey, JSON.stringify(this.data));
            console.log('üíæ Anniversary data saved successfully');
            return true;
        } catch (error) {
            console.error('Error saving data:', error);
            return false;
        }
    }

    /**
     * Create backup of current data
     */
    createBackup() {
        try {
            const backup = {
                timestamp: new Date().toISOString(),
                version: this.version,
                data: this.data
            };
            
            localStorage.setItem(this.backupKey, JSON.stringify(backup));
            console.log('üíæ Backup created successfully');
            return true;
        } catch (error) {
            console.error('Error creating backup:', error);
            return false;
        }
    }

    /**
     * Restore from backup
     */
    restoreFromBackup() {
        try {
            const backup = localStorage.getItem(this.backupKey);
            if (backup) {
                const parsed = JSON.parse(backup);
                this.data = parsed.data;
                this.saveData();
                console.log('üì• Data restored from backup');
                return true;
            }
        } catch (error) {
            console.error('Error restoring backup:', error);
        }
        return false;
    }

    /**
     * Export data as JSON
     */
    exportAsJSON() {
        const exportData = {
            exportDate: new Date().toISOString(),
            version: this.version,
            data: this.data
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {
            type: 'application/json'
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `anniversary-data-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        console.log('üì§ Data exported as JSON');
    }

    /**
     * Import data from JSON file
     */
    importFromJSON(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.data) {
                        this.createBackup(); // Backup current data first
                        this.data = this.mergeWithDefaults(imported.data);
                        this.saveData();
                        console.log('üì• Data imported successfully');
                        resolve(true);
                    } else {
                        reject(new Error('Invalid data format'));
                    }
                } catch (error) {
                    reject(error);
                }
            };
            reader.readAsText(file);
        });
    }

    /**
     * Calculate days together
     */
    calculateDaysTogether(startDate) {
        const start = new Date(startDate);
        const today = new Date();
        const diffTime = Math.abs(today - start);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    /**
     * Setup auto-save functionality
     */
    setupAutoSave() {
        setInterval(() => {
            this.saveData();
        }, this.autoSaveInterval);
        
        // Save before page unload
        window.addEventListener('beforeunload', () => {
            this.saveData();
        });
    }

    // =================== DATA MANIPULATION METHODS ===================

    /**
     * Add new timeline entry
     */
    addTimelineEntry(entry) {
        const newEntry = {
            id: Date.now(),
            date: entry.date || new Date().toISOString().split('T')[0],
            title: entry.title || "New Memory",
            description: entry.description || "",
            category: entry.category || "memory",
            image: entry.image || null,
            location: entry.location || null,
            tags: entry.tags || [],
            favorite: entry.favorite || false,
            created: new Date().toISOString()
        };
        
        this.data.timeline.push(newEntry);
        this.data.statistics.totalMemories = this.data.timeline.length;
        this.saveData();
        
        console.log('‚ûï New timeline entry added:', newEntry.title);
        return newEntry;
    }

    /**
     * Add new photo
     */
    addPhoto(photo) {
        const newPhoto = {
            id: Date.now(),
            filename: photo.filename || "new-photo.jpg",
            title: photo.title || "New Photo",
            description: photo.description || "",
            date: photo.date || new Date().toISOString().split('T')[0],
            category: photo.category || "memories",
            tags: photo.tags || [],
            favorite: photo.favorite || false,
            uploaded: new Date().toISOString()
        };
        
        this.data.photos.push(newPhoto);
        this.data.statistics.totalPhotos = this.data.photos.length;
        this.saveData();
        
        console.log('üì∏ New photo added:', newPhoto.title);
        return newPhoto;
    }

    /**
     * Add new love letter
     */
    addLoveLetter(letter) {
        const newLetter = {
            id: Date.now(),
            date: letter.date || new Date().toISOString().split('T')[0],
            title: letter.title || "Love Letter",
            content: letter.content || "",
            author: letter.author || this.data.couple.partner1.name,
            recipient: letter.recipient || this.data.couple.partner2.name,
            mood: letter.mood || "romantic",
            tags: letter.tags || [],
            favorite: letter.favorite || false,
            created: new Date().toISOString()
        };
        
        this.data.loveLetters.push(newLetter);
        this.data.statistics.totalLetters = this.data.loveLetters.length;
        this.saveData();
        
        console.log('üíå New love letter added:', newLetter.title);
        return newLetter;
    }

    /**
     * Get data by category
     */
    getTimelineByCategory(category) {
        return this.data.timeline.filter(entry => entry.category === category);
    }

    getPhotosByCategory(category) {
        return this.data.photos.filter(photo => photo.category === category);
    }

    getFavoriteMemories() {
        return this.data.timeline.filter(entry => entry.favorite);
    }

    getFavoritePhotos() {
        return this.data.photos.filter(photo => photo.favorite);
    }

    /**
     * Search functionality
     */
    searchMemories(query) {
        const lowerQuery = query.toLowerCase();
        return this.data.timeline.filter(entry => 
            entry.title.toLowerCase().includes(lowerQuery) ||
            entry.description.toLowerCase().includes(lowerQuery) ||
            entry.tags.some(tag => tag.toLowerCase().includes(lowerQuery))
        );
    }

    /**
     * Update statistics
     */
    updateStatistics() {
        this.data.statistics = {
            ...this.data.statistics,
            totalMemories: this.data.timeline.length,
            totalPhotos: this.data.photos.length,
            totalLetters: this.data.loveLetters.length,
            totalSongs: this.data.musicPlaylist.length,
            daysogether: this.calculateDaysTogether(this.data.couple.relationshipStart),
            lastVisit: new Date().toISOString()
        };
        
        this.saveData();
    }

    /**
     * Get all data (for debugging or full access)
     */
    getAllData() {
        return this.data;
    }

    /**
     * Reset all data to defaults
     */
    resetAllData() {
        if (confirm('Are you sure you want to reset all data? This cannot be undone!')) {
            this.createBackup();
            this.data = this.createDefaultDataStructure();
            this.saveData();
            console.log('üîÑ All data reset to defaults');
            return true;
        }
        return false;
    }
}

// Initialize global instance
window.anniversaryData = new AnniversaryDataManager();

// Export for module systems
if (typeof module !== 'undefined' && module.exports) {
    module.exports = AnniversaryDataManager;
}

console.log('üíï Anniversary Data Manager loaded successfully!');
