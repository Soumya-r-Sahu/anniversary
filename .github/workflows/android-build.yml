name: Build Android APK/AAB for Android 13+

on:
  push:
    branches: [ main, master, flutter-test-branch ]
    paths:
      - 'anniversary_flutter/**'
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'anniversary_flutter/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java 17 (Required for Android 13+)
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter (Latest Stable)
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.6'
        channel: 'stable'
        cache: true
        
    - name: Install dependencies
      working-directory: ./anniversary_flutter
      run: flutter pub get
      
    - name: Verify Flutter installation
      run: flutter doctor -v
      
    - name: Analyze Flutter code
      working-directory: ./anniversary_flutter
      run: flutter analyze
      
    - name: Run Flutter tests
      working-directory: ./anniversary_flutter
      run: flutter test
      
    - name: Build Android APK (Multi-architecture)
      working-directory: ./anniversary_flutter
      run: |
        flutter build apk --release \
          --target-platform android-arm,android-arm64,android-x64 \
          --split-per-abi
      
    - name: Build App Bundle (AAB)
      working-directory: ./anniversary_flutter
      run: flutter build appbundle --release
      
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: anniversary-love-android-apks
        path: |
          anniversary_flutter/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          anniversary_flutter/build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          anniversary_flutter/build/app/outputs/flutter-apk/app-x86_64-release.apk
        retention-days: 30
        
    - name: Upload App Bundle artifact
      uses: actions/upload-artifact@v4
      with:
        name: anniversary-love-android-aab
        path: anniversary_flutter/build/app/outputs/bundle/release/app-release.aab
        retention-days: 30        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          anniversary_flutter/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          anniversary_flutter/build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          anniversary_flutter/build/app/outputs/flutter-apk/app-x86_64-release.apk
          anniversary_flutter/build/app/outputs/bundle/release/app-release.aab
        name: Anniversary Love ${{ github.ref_name }} - Android 13+ Compatible
        body: |
          ## ğŸ‰ Anniversary Love Android Release
          
          ### ğŸ“± Android Compatibility
          - **Minimum Android Version**: Android 5.0 (API 21)
          - **Target Android Version**: Android 14 (API 34)
          - **Optimized for**: Android 13+ features and security
          
          ### ğŸ“¦ Download Options
          
          #### APK Files (Direct Installation)
          - **app-arm64-v8a-release.apk** - For modern 64-bit devices (Recommended)
          - **app-armeabi-v7a-release.apk** - For older 32-bit devices
          - **app-x86_64-release.apk** - For x86 devices/emulators
          
          #### AAB File (Google Play Store)
          - **app-release.aab** - For Google Play Store distribution
          
          ### âœ¨ Features
          - ğŸµ Background music with Android 13+ notification controls
          - ğŸ–¼ï¸ Photo gallery with granular media permissions
          - ğŸ’« Smooth 60fps animations optimized for all devices
          - ğŸ”” Smart notification management (Android 13+ compatible)
          - ğŸ­ Immersive fullscreen experience
          - ğŸ’¾ Secure data backup and restore
          - ğŸŒŸ Themed app icons (Android 13+ dynamic theming)
          
          ### ğŸ› ï¸ Installation Instructions
          
          #### For APK Installation:
          1. Download the appropriate APK for your device architecture
          2. Enable "Install from Unknown Sources" in your device settings
          3. Install the APK file
          4. Grant required permissions when prompted
          
          #### For Developers:
          - Use the AAB file for Google Play Store distribution
          - All files are signed and optimized for production use
          
          ### ğŸ”’ Permissions Explained
          - **Storage Access**: For photo gallery and music caching
          - **Audio Recording**: For enhanced audio experience (optional)
          - **Notifications**: For music playback controls
          - **Network Access**: For web-based features and updates
          
          ### ğŸ¯ System Requirements
          - Android 5.0+ (minimum)
          - 50MB free storage space
          - Audio output capability
          - Optional: Camera for photo features
          
          Built with Flutter 3.19.x | Targeting Android 14 (API 34)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
